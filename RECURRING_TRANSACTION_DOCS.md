# 定期交易功能文档

## 概述

定期交易功能允许用户创建周期性的交易模板，支持灵活的重复周期设置（类似 Google Calendar），并可以选择自动添加或手动确认。

## 主要功能

### 1. 灵活的重复周期

支持以下重复模式：

#### 每天
- 每天重复
- 每 N 天重复（例如：每 2 天、每 3 天）

#### 每周
- 选择一个或多个星期几
- 每 N 周重复（例如：每 2 周）
- 示例：每周一和周三、每两周的周五

#### 每月
- 选择每月的具体日期（1-31号）
- 每 N 月重复（例如：每 2 月、每 3 月）
- 示例：每月 15 号、每 2 个月的 1 号

#### 每年
- 选择每年的具体月份和日期
- 每 N 年重复
- 示例：每年 12 月 25 日、每 2 年的 1 月 1 日

### 2. 自动添加 vs 手动确认

#### 自动添加
- 开启后，系统会在每个周期自动创建交易记录
- 适合固定的周期性支出，如：房租、订阅服务、会员费用
- 无需手动确认，自动入账

#### 手动确认
- 开启后，系统会在每个周期提醒用户确认
- 用户可以选择确认或跳过
- 适合可能有变化的周期性交易，如：通勤费用、定期购物

### 3. 结束条件

可以设置以下结束条件来限制重复：

#### 结束日期
- 设置一个具体的结束日期
- 到达该日期后，定期交易将不再执行
- 示例：订阅到 2024 年 12 月 31 日结束

#### 重复次数
- 设置重复的总次数
- 执行指定次数后自动停止
- 示例：重复 10 次后结束

### 4. 其他功能

- **暂停/启用**：可以随时暂停或重新启用定期交易
- **执行历史**：记录上次执行时间和已执行次数
- **友好显示**：以易读的方式显示重复规则（如"每2周（周一、周三）"）

## 使用示例

### 示例 1：每月房租（自动添加）

```
名称：房租
金额：3000
类型：支出
分类：住房
频率：每月
日期：1号
自动添加：开启
```

系统会在每月 1 号自动创建一笔 3000 元的房租支出记录。

### 示例 2：工作日通勤费（手动确认）

```
名称：通勤费
金额：20
类型：支出
分类：交通
频率：每周
星期：周一、周二、周三、周四、周五
自动添加：关闭
```

系统会在每个工作日提醒您确认通勤费，您可以根据实际情况选择确认或跳过。

### 示例 3：季度会员费（有限次数）

```
名称：健身房会员
金额：500
类型：支出
分类：运动
频率：每月
间隔：3（每3个月）
日期：1号
重复次数：4次
自动添加：开启
```

系统会每 3 个月的 1 号自动创建会员费记录，总共执行 4 次（即 1 年）。

### 示例 4：年度保险（固定日期）

```
名称：车险
金额：5000
类型：支出
分类：汽车
频率：每年
月份：3月
日期：15号
自动添加：开启
```

系统会在每年 3 月 15 日自动创建车险支出记录。

## 技术实现

### 数据模型

`RecurringTransaction` 模型包含以下主要字段：

- `frequency`: 频率（daily/weekly/monthly/yearly）
- `interval`: 间隔（每 N 天/周/月/年）
- `weekdays`: 星期几列表（用于每周）
- `dayOfMonth`: 每月/年的日期
- `monthOfYear`: 月份（用于每年）
- `autoAdd`: 是否自动添加
- `endDate`: 结束日期（可选）
- `occurrenceCount`: 重复次数限制（可选）
- `executedCount`: 已执行次数
- `lastExecutedDate`: 上次执行日期

### 执行逻辑

系统在以下时机检查定期交易：

1. **App 启动时**：加载所有启用的定期交易并检查是否需要执行
2. **App 进入前台时**：再次检查（每天只检查一次）

对于每个定期交易，系统会：

1. 检查是否已达到结束日期或重复次数限制
2. 检查今天是否符合重复规则
3. 检查今天是否已经执行过
4. 如果符合条件：
   - **自动添加模式**：直接创建交易记录
   - **手动确认模式**：显示确认对话框

### UI 组件

- `RecurringTransactionListView`: 定期交易列表
- `AddRecurringTransactionView`: 添加定期交易表单
- `EditRecurringTransactionView`: 编辑定期交易表单
- `RecurringTransactionConfirmationView`: 手动确认对话框

## 最佳实践

### 适合自动添加的场景

- 固定金额的定期支出（房租、订阅、保险）
- 每月固定的收入（工资）
- 不会变化的周期性费用

### 适合手动确认的场景

- 金额可能变化的周期性支出（水电费、话费）
- 不一定每次都发生的周期性活动（每周购物）
- 需要灵活调整的交易

### 建议

1. **合理使用间隔功能**：对于不是每天/周/月都发生的交易，使用间隔功能而不是创建多个定期交易
2. **设置结束条件**：对于有明确结束时间的订阅或服务，设置结束日期或重复次数
3. **定期检查**：定期查看已执行的定期交易，确保没有不再需要的项目
4. **使用描述性名称**：给定期交易起一个清晰的名称，便于识别和管理

## 常见问题

### Q: 如果错过了某天的定期交易会怎样？

A: 系统会检测遗漏的交易：
- 对于**自动添加**模式：下次检查时会自动补上遗漏的记录
- 对于**手动确认**模式：下次打开 App 时会提示您确认

### Q: 可以修改已经创建的定期交易吗？

A: 可以。修改定期交易不会影响已经创建的交易记录，只会影响未来的执行。

### Q: 如何暂时停止某个定期交易？

A: 在编辑页面关闭"启用"开关即可。需要时可以随时重新开启。

### Q: 已执行次数可以重置吗？

A: 目前不支持手动重置。如果需要重新开始计数，可以删除旧的定期交易并创建一个新的。

### Q: 多个星期几的定期交易如何处理间隔？

A: 间隔是基于整周计算的。例如"每2周的周一和周三"表示在第1周和第3周的周一、周三执行，第2周和第4周跳过。

## 更新日志

### v1.0.0 (2024-01-29)

- ✅ 支持每天/每周/每月/每年四种基础频率
- ✅ 支持自定义间隔（每 N 天/周/月/年）
- ✅ 支持每周多个星期几选择
- ✅ 支持自动添加和手动确认两种模式
- ✅ 支持结束日期和重复次数限制
- ✅ 显示友好的重复规则描述
- ✅ 记录执行历史和次数
- ✅ 完整的单元测试覆盖
