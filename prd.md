## 0) 产品范围确认（基于你的 4 点决策）

- 支持**多成员不同 Apple ID**通过共享 iCloud 文件夹协作记账（需要重点做冲突与权限体验）。
- OCR 支持两条路径：
  - **本地 Apple OCR**（优先隐私、速度）
  - **第三方模型 OCR/视觉**（更强识别能力，可选）
- 分摊规则：**默认等分**（可在单笔里调整参与人）。
- 不做转账/资产账户体系（简化：所有记录以收支为主）。

---

## 1) 用户与场景（User Stories）

1. 作为家庭成员，我想把**支付截图/小票**发给聊天框，自动生成一笔或多笔记录，少填字段。
2. 作为家庭成员，我想通过一句话补充信息：`这笔我付的，三人均摊，备注晚餐`，并快速确认入账。
3. 作为家庭管理员，我想邀请家人加入共享账本，并设置哪些人能改设置/导出数据。
4. 作为家庭用户，我想按月查看分类支出、对比谁花了更多（或谁承担了更多分摊）。
5. 作为注重隐私的用户，我想只用**本地 OCR**，不把截图发给第三方。
6. 作为高级用户，我想切换 AI 模型、配置 Key、调整解析规则，让识别更符合我家的分类习惯。
7. 作为任何成员，我想导出某月 CSV 给电脑处理，且数据结构稳定可迁移。

---

## 2) 功能拆解（按模块更细化）

## 2.1 聊天记账（核心）

### A. 输入与预处理
- 支持输入：文本、单图、多图、图文混合
- 图片预处理（可选，但建议）
  - 自动裁剪/旋转（提高 OCR 成功率）
  - 关键区域检测（支付金额区域优先）

### B. OCR 路径选择
- 模式 1：**Apple 本地 OCR**
  - 流程：图片 → Vision/OCR → 文本 → LLM 结构化
  - 优点：隐私友好、快；缺点：遇到复杂版式可能不如三方
- 模式 2：**第三方模型视觉**
  - 流程：图片 → 视觉模型 → 直接结构化或先转文本再结构化
  - 提醒：需给用户明确开关与提示“图片将发送到第三方”

### C. 结构化与生成“待确认记账卡片”
- 支持输出多笔交易（例如账单列表截图）
- 每笔交易生成卡片字段（建议 MVP 必备）
  - 日期（默认今天，可从截图推断）
  - 金额
  - 分类（可由 AI 推断）
  - 付款人（从成员里选，默认当前用户）
  - 参与人（默认“全家”，等分）
  - 备注/商户（从截图或文本提取）
- 卡片操作
  - `确认入账`
  - `编辑`
  - `删除`
  - 批量：`全选确认`、`部分确认`

### D. 聊天式纠错与追问
- 置信度低时触发追问
  - “这笔是支出还是收入？”
  - “金额识别到 128/1280，你确认是哪一个？”
  - “参与人是全家吗？”
- 支持自然语言修正
  - “刚才那笔改成 86.5”
  - “分类改为买菜”
  - “这笔只算我和老婆两人”

---

## 2.2 账本（明细、搜索、编辑）

- 明细列表
  - 按天分组、月汇总
  - 快速筛选：时间、分类、成员（付款人/承担人）、金额区间、商户关键词
- 交易详情页
  - 完整字段编辑
  - 查看来源：文本片段、OCR 结果（可选显示，便于纠错）
  - 参与人/等分结果展示（每人承担金额）
- 快捷操作
  - 长按复用：复制一笔（如每周买菜）
  - 标记常用商户/常用分类

---

## 2.3 家庭与共享（iCloud 协作的关键）

### A. 共享方式
- 以 iCloud Drive 文件夹为“账本容器”，支持：
  - 创建账本文件夹
  - 发起共享（系统分享面板）
  - 加入已有共享账本

### B. 成员管理
- 成员列表（昵称/头像）
- 角色建议（简单两级即可）
  - 管理员：模型配置、导出、分类体系修改
  - 成员：记账、查看、编辑自己/全部（可选）
- 成员识别
  - 使用 iCloud 身份标识 + 本地映射到昵称（注意跨设备一致性）

### C. 多设备并发与冲突处理（必须设计）
- 冲突类型
  - 两人同时写同一月 CSV
  - 一人编辑、另一人删除同一笔
- 策略建议（产品 + 实现都相对可控）
  - 每笔记录有 `id`（UUID）+ `updated_at`
  - 修改写入时采用“读-合并-写”流程
  - 发现 iCloud 冲突副本时：
    - 提示“检测到冲突版本”
    - 提供“自动合并（按 updated_at）/手动选择保留哪个版本”
- 降低冲突概率（体验层）
  - 按月拆文件：`transactions_YYYY-MM.csv`
  - 写入节流：短时间多笔记账先写本地缓存，合并后再写 iCloud

---

## 2.4 设置（AI 模型、OCR、数据）

### A. AI 模型配置
- 模型提供商选择
- API Key（Keychain）
- 高级参数：温度、输出语言、字段严格模式
- “测试解析”入口：粘贴一段文本/选一张图，预览结构化结果

### B. OCR 设置
- OCR 模式切换：
  - 仅本地 OCR
  - 允许第三方识图（提示隐私）
- 识别语言：中文/英文/自动
- 图片上传策略（第三方模式下）
  - 原图/压缩图（节省流量与成本）

### C. 数据设置
- iCloud 状态：已登录/未登录、共享账本位置
- 导入/导出 CSV
- 数据字段版本号（用于未来升级）

---

## 2.5 报表与预算（建议做成 V1，但可规划在架构里）

- 月度收支总览
- 分类占比
- 成员承担支出（按等分后的承担金额统计，而不仅是付款人）
- 预算（按分类/月）
  - 预算进度
  - 超支提醒（可本地通知）

---

## 3) 数据与 CSV 设计（与“等分 + 家庭共享”匹配）

## 3.1 CSV 文件结构建议

- `transactions_YYYY-MM.csv`：按月交易
- `members.csv`：成员定义
- `categories.csv`：分类
- `settings.json`（可选）：账本级配置（例如默认分摊范围、币种）

## 3.2 交易表字段（建议）

最小字段（MVP）：

- `id`
- `created_at`
- `updated_at`
- `date`
- `amount`
- `category`
- `payer`
- `participants`（用 `;` 分隔，如 `Alice;Bob;Kid`）
- `note`
- `source`（text/apple_ocr/vision_model）

建议字段（强烈推荐，后续报表/纠错更好用）：

- `merchant`
- `currency`
- `ocr_text`（可选，注意隐私：可只存摘要或不存）
- `confidence_amount`、`confidence_date`（可选）

> 等分不一定要把“每人分摊金额”落表；可以运行时计算：`amount / participants_count`。如果未来要支持不等分，再引入 `split_detail`。

---

## 4) MVP 验收标准（写给研发/测试的“能否上线”）

1. **文本记账**
   - 输入 `晚餐 128 我和老婆` → 生成卡片：金额 128、分类餐饮、参与人2人等分、确认后出现在明细列表。
2. **截图记账（Apple OCR）**
   - 选一张支付截图 → 本地 OCR → 识别金额与商户（至少金额必须稳定）→ 可确认入账。
3. **截图记账（第三方视觉）**
   - 开关开启后可用；关闭时不允许发送图片（明确提示）。
4. **家庭共享**
   - A 创建账本并共享给 B；B 加入后能看到 A 的新增记录。
   - A/B 同时新增多笔，不出现数据丢失（允许出现短暂延迟）。
5. **冲突处理**
   - 模拟 iCloud 冲突文件出现时，用户能被提示并可选择合并/保留。
6. **CSV 可用**
   - 导出 CSV 在电脑打开字段正确，金额/日期不乱码。
7. **模型配置**
   - 可配置 provider + API key；“测试解析”能出结构化预览。

